<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Nexus Chess | Hyper-Strategic Analyzer</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chess.js voor spellogica -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Markdown Parser for AI responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* --- Strategic Cyber-Minimalism Custom Styles --- */
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600&display=swap');

        :root {
            --obsidian: #0A0A0F;
            --cyan: #00FFFF;
            --cyan-dim: rgba(0, 255, 255, 0.1);
            --glass: rgba(255, 255, 255, 0.05);
        }

        body {
            background-color: var(--obsidian);
            color: #F8F8FF;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Board Colors */
        .square-dark { background-color: #1a237e; color: white; } /* Deep Blue */
        .square-light { background-color: #374151; color: #0A0A0F; } /* Matte Gray */
        
        /* Effects */
        .nexus-glow { box-shadow: 0 0 15px rgba(0, 255, 255, 0.2); }
        .nexus-border { border: 1px solid rgba(0, 255, 255, 0.3); }
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Kinetic Animations */
        .piece {
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .piece:hover { transform: scale(1.1); filter: drop-shadow(0 0 5px var(--cyan)); }
        
        .selected-square {
            box-shadow: inset 0 0 15px var(--cyan);
            border: 1px solid var(--cyan);
        }

        .highlight-move {
            background: rgba(0, 255, 255, 0.2) !important;
        }

        /* Scanline effect overlay */
        .scanlines {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 50;
            opacity: 0.15;
        }
        
        /* Modal */
        .modal-hidden { display: none; }
        .modal-flex { display: flex; }

        /* Form Elements */
        .nexus-input {
            width: 100%;
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 0.5rem;
            font-family: 'JetBrains Mono', monospace;
            border-radius: 0.25rem;
            transition: all 0.2s;
        }
        .nexus-input:focus {
            border-color: var(--cyan);
            outline: none;
            box-shadow: 0 0 10px rgba(0,255,255,0.2);
        }

        /* Markdown Styles in Chat */
        .prose p { margin-bottom: 0.5em; }
        .prose strong { color: var(--cyan); }
    </style>
</head>
<body class="min-h-screen flex flex-col md:flex-row selection:bg-cyan-500/30">

    <div class="scanlines"></div>

    <!-- LEFT PANEL: Strategy Hub -->
    <aside class="w-full md:w-80 glass-panel p-6 flex flex-col gap-6 z-10 border-r border-white/5 relative">
        <div class="flex items-center gap-3 animate-pulse">
            <div class="w-12 h-12 rounded-full border-2 border-cyan-400 p-1 flex items-center justify-center bg-black">
                <i data-lucide="brain-circuit" class="text-cyan-400"></i>
            </div>
            <div>
                <h2 class="font-bold text-lg tracking-wider">PROJECT NEXUS</h2>
                <div class="text-xs text-cyan-400 font-mono flex items-center gap-1">
                    <i data-lucide="shield" size="10"></i> v2.0 GEMINI
                </div>
            </div>
        </div>

        <div>
            <h3 class="text-xs uppercase tracking-widest text-gray-400 mb-2 font-mono">Opponent Elo</h3>
            <div id="display-elo" class="text-4xl font-mono font-bold text-white drop-shadow-[0_0_10px_rgba(0,255,255,0.5)]">
                1200
            </div>
            <!-- Simple SVG Graph -->
            <div class="relative h-24 w-full mt-2 bg-black/40 rounded border border-white/5 overflow-hidden">
                <svg width="100%" height="100%" viewBox="0 0 100 50" preserveAspectRatio="none">
                    <path d="M0,50 L10,35 L30,40 L50,20 L70,25 L100,5" fill="none" stroke="#00FFFF" stroke-width="2" />
                    <circle cx="100" cy="5" r="3" fill="white" class="animate-ping" />
                </svg>
            </div>
        </div>

        <div class="mt-auto space-y-3">
            <button onclick="resetGame()" class="w-full py-3 bg-cyan-500/10 border border-cyan-500/50 text-cyan-400 font-mono text-sm hover:bg-cyan-500 hover:text-black transition-all duration-300 uppercase tracking-widest flex items-center justify-center gap-2 group">
                <i data-lucide="refresh-cw" class="w-4 h-4"></i> RESET BOARD
            </button>
            <button onclick="toggleSettings()" class="w-full py-3 bg-gray-800/50 border border-gray-600 text-gray-300 font-mono text-sm hover:bg-white hover:text-black transition-all uppercase tracking-widest flex items-center justify-center gap-2">
                <i data-lucide="settings" class="w-4 h-4"></i> NEURAL SETTINGS
            </button>
        </div>
    </aside>

    <!-- CENTER PANEL: Nexus Board -->
    <main class="flex-1 flex flex-col items-center justify-center p-4 relative bg-gradient-to-b from-[#0A0A0F] to-[#12121a]">
        <!-- Ambient Glow -->
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[500px] h-[500px] bg-cyan-500/5 blur-[100px] rounded-full pointer-events-none"></div>

        <div class="mb-6 flex items-center gap-4 px-6 py-2 rounded-full bg-black/40 border border-white/10 backdrop-blur-md">
            <div id="turn-indicator" class="w-3 h-3 rounded-full bg-white shadow-[0_0_10px_white] transition-colors"></div>
            <span id="game-status" class="font-mono text-sm tracking-widest text-cyan-400">WHITE TO MOVE</span>
        </div>

        <div class="relative p-2 bg-[#1a1a20] rounded-lg shadow-2xl shadow-black nexus-border">
            <div id="chessboard" class="grid grid-cols-8 grid-rows-8 w-[320px] h-[320px] md:w-[560px] md:h-[560px]">
                <!-- Board generated by JS -->
            </div>
        </div>
    </main>

    <!-- RIGHT PANEL: Adaptive Coach -->
    <aside class="w-full md:w-96 glass-panel border-l border-white/5 flex flex-col">
        <div class="p-6 border-b border-white/5">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-mono text-cyan-400 tracking-widest flex items-center gap-2">
                    <i data-lucide="sparkles"></i> GEMINI COACH
                </h3>
                <span id="api-status" class="px-2 py-1 bg-gray-500/20 text-gray-400 text-xs rounded font-mono border border-gray-500/30">DISCONNECTED</span>
            </div>
            
            <div class="bg-black/40 p-4 rounded border border-white/10 h-48 overflow-y-auto font-mono text-xs text-gray-300 prose prose-invert" id="ai-feedback">
                <p>> SYSTEM WAITING...</p>
                <p>> ENTER API KEY TO ENABLE NEURAL LINK.</p>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-2" id="move-history">
            <div class="text-xs text-gray-500 font-mono mb-2">MOVE SEQUENCE</div>
            <!-- Moves injected here -->
        </div>

        <div class="p-4 border-t border-white/5 bg-black/20 space-y-2">
            <button onclick="analyzeWithGemini('strategic')" class="w-full py-2 bg-gradient-to-r from-cyan-900 to-blue-900 text-cyan-100 text-xs font-mono rounded transition-all hover:brightness-125 flex items-center justify-center gap-2 border border-cyan-500/30">
                <i data-lucide="zap"></i> ✨ STRATEGIC ANALYSIS
            </button>
            <button onclick="analyzeWithGemini('roast')" class="w-full py-2 bg-gradient-to-r from-red-900/50 to-orange-900/50 text-orange-200 text-xs font-mono rounded transition-all hover:brightness-125 flex items-center justify-center gap-2 border border-orange-500/30">
                <i data-lucide="skull"></i> ✨ ROAST MY MOVE
            </button>
        </div>
    </aside>

    <!-- API SETTINGS MODAL -->
    <div id="settings-modal" class="fixed inset-0 z-50 modal-hidden items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="glass-panel p-8 rounded-lg max-w-md w-full border border-cyan-500/30 shadow-[0_0_30px_rgba(0,255,255,0.1)]">
            <h2 class="text-xl font-bold mb-6 font-mono text-cyan-400 border-b border-white/10 pb-2">NEURAL LINK SETTINGS</h2>
            
            <!-- ELO SELECTION -->
            <div class="mb-6">
                <label class="block text-xs font-mono text-cyan-200 mb-2">ENGINE DIFFICULTY (ELO)</label>
                <select id="elo-select" class="nexus-input cursor-pointer">
                    <option value="800">800 - RECRUIT (Random/Easy)</option>
                    <option value="1200">1200 - CLUB (Balanced)</option>
                    <option value="1600">1600 - EXPERT (Aggressive)</option>
                    <option value="2400">2400 - GRANDMASTER (Hyper-Calc)</option>
                </select>
                <p class="text-[10px] text-gray-500 mt-1">Adjusts the AI's tactical aggression and error rate.</p>
            </div>

            <!-- API KEY -->
            <div class="mb-6">
                <label class="block text-xs font-mono text-cyan-200 mb-2">GEMINI API KEY</label>
                <input type="password" id="api-key-input" class="nexus-input" placeholder="Enter key starting with AIza...">
                <p class="text-[10px] text-gray-500 mt-1">Required for text-based analysis. Key is stored locally.</p>
            </div>
            
            <div class="flex gap-2 justify-end pt-4">
                <button onclick="toggleSettings()" class="px-4 py-2 text-xs font-mono text-gray-400 hover:text-white transition-colors">CANCEL</button>
                <button onclick="saveSettings()" class="px-4 py-2 bg-cyan-600 text-white text-xs font-mono rounded hover:bg-cyan-500 shadow-[0_0_10px_rgba(0,255,255,0.3)] transition-all">SAVE & SYNC</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIG & STATE ---
        lucide.createIcons();
        const game = new Chess();
        let boardEl = document.getElementById('chessboard');
        let selectedSquare = null;
        let aiEnabled = true;
        
        // Load settings
        let apiKey = localStorage.getItem('nexus_api_key') || '';
        let currentElo = localStorage.getItem('nexus_elo') || '1200';

        // Init Form Values
        if(apiKey) {
            document.getElementById('api-key-input').value = apiKey;
            updateApiStatus(true);
        }
        document.getElementById('elo-select').value = currentElo;
        document.getElementById('display-elo').innerText = currentElo;

        // Piece Unicode Mapping
        const PIECES = {
            'p': '♟', 'r': '♜', 'n': '♞', 'b': '♝', 'q': '♛', 'k': '♚',
            'P': '♙', 'R': '♖', 'N': '♘', 'B': '♗', 'Q': '♕', 'K': '♔'
        };
        
        const PIECE_VALUES = {
            'p': 1, 'n': 3, 'b': 3, 'r': 5, 'q': 9, 'k': 0
        };

        function updateApiStatus(connected) {
            const el = document.getElementById('api-status');
            if(connected) {
                el.innerText = "CONNECTED";
                el.className = "px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded font-mono border border-green-500/30";
            } else {
                el.innerText = "DISCONNECTED";
                el.className = "px-2 py-1 bg-red-500/20 text-red-400 text-xs rounded font-mono border border-red-500/30";
            }
        }

        // --- 2. RENDER ENGINE ---
        function drawBoard() {
            boardEl.innerHTML = '';
            const board = game.board();

            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const square = String.fromCharCode(97 + col) + (8 - row);
                    const piece = board[row][col];
                    const isDark = (row + col) % 2 === 1;
                    
                    const cell = document.createElement('div');
                    cell.className = `relative flex items-center justify-center text-4xl select-none 
                        ${isDark ? 'square-dark' : 'square-light'} 
                        ${selectedSquare === square ? 'selected-square' : ''}`;
                    
                    // Highlight last move
                    const history = game.history({ verbose: true });
                    if (history.length > 0) {
                        const lastMove = history[history.length - 1];
                        if (lastMove.from === square || lastMove.to === square) {
                            cell.classList.add('highlight-move');
                        }
                    }

                    // Labels
                    if (col === 0) cell.innerHTML += `<span class="absolute left-1 top-1 text-[10px] opacity-50 font-mono">${8 - row}</span>`;
                    if (row === 7) cell.innerHTML += `<span class="absolute right-1 bottom-0 text-[10px] opacity-50 font-mono">${String.fromCharCode(97 + col)}</span>`;

                    // Piece
                    if (piece) {
                        const span = document.createElement('span');
                        span.className = `piece transition-transform ${piece.color === 'w' ? 'text-gray-100 drop-shadow-md' : 'text-black drop-shadow-sm'}`;
                        span.innerText = PIECES[piece.color === 'w' ? piece.type.toUpperCase() : piece.type];
                        cell.appendChild(span);
                    } else if (selectedSquare) {
                        const moves = game.moves({ square: selectedSquare, verbose: true });
                        if (moves.find(m => m.to === square)) {
                            const dot = document.createElement('div');
                            dot.className = 'w-3 h-3 bg-cyan-400/50 rounded-full animate-pulse cursor-pointer';
                            dot.onclick = (e) => {
                                e.stopPropagation();
                                handleMove(selectedSquare, square);
                            };
                            cell.appendChild(dot);
                        }
                    }

                    cell.onclick = () => handleSquareClick(square);
                    boardEl.appendChild(cell);
                }
            }
            updateStatus();
        }

        // --- 3. GAME LOGIC ---
        function handleSquareClick(square) {
            if (game.game_over()) return;

            if (selectedSquare === square) {
                selectedSquare = null;
                drawBoard();
                return;
            }

            if (selectedSquare) {
                const move = game.move({
                    from: selectedSquare,
                    to: square,
                    promotion: 'q'
                });

                if (move) {
                    selectedSquare = null;
                    drawBoard();
                    addMoveToHistory(move);
                    
                    if (!game.game_over()) {
                        document.getElementById('game-status').innerText = `CALCULATING (${currentElo})...`;
                        const delay = currentElo > 1600 ? 1000 : 500;
                        setTimeout(makeAIMove, delay);
                    }
                } else {
                    const piece = game.get(square);
                    if (piece && piece.color === game.turn()) {
                        selectedSquare = square;
                        drawBoard();
                    } else {
                        selectedSquare = null;
                        drawBoard();
                    }
                }
            } else {
                const piece = game.get(square);
                if (piece && piece.color === game.turn()) {
                    selectedSquare = square;
                    drawBoard();
                }
            }
        }

        function handleMove(from, to) {
            game.move({ from, to, promotion: 'q' });
            selectedSquare = null;
            drawBoard();
            addMoveToHistory(game.history({ verbose: true }).pop());
            const delay = currentElo > 1600 ? 1000 : 500;
            setTimeout(makeAIMove, delay);
        }

        // --- 4. SCALABLE AI (ELO BASED) ---
        function makeAIMove() {
            if (game.game_over()) return;

            const moves = game.moves({ verbose: true });
            if (moves.length === 0) return;

            let chosenMove = null;
            const elo = parseInt(currentElo);

            const captures = moves.filter(m => m.flags.includes('c') || m.flags.includes('e'));
            
            captures.sort((a, b) => {
                const valA = PIECE_VALUES[a.captured] || 0;
                const valB = PIECE_VALUES[b.captured] || 0;
                return valB - valA;
            });

            if (elo === 800) {
                if (Math.random() < 0.2 && captures.length > 0) {
                    chosenMove = captures[Math.floor(Math.random() * captures.length)];
                } else {
                    chosenMove = moves[Math.floor(Math.random() * moves.length)];
                }
            } 
            else if (elo === 1200) {
                if (Math.random() < 0.5 && captures.length > 0) {
                    chosenMove = captures[0];
                } else {
                    chosenMove = moves[Math.floor(Math.random() * moves.length)];
                }
            }
            else if (elo === 1600) {
                if (captures.length > 0) {
                    chosenMove = captures[0];
                } else {
                    const centerMoves = moves.filter(m => m.to.includes('d4') || m.to.includes('e4') || m.to.includes('d5') || m.to.includes('e5'));
                    if (centerMoves.length > 0 && Math.random() < 0.6) {
                        chosenMove = centerMoves[0];
                    } else {
                        chosenMove = moves[Math.floor(Math.random() * moves.length)];
                    }
                }
            }
            else if (elo >= 2400) {
                const mates = moves.filter(m => {
                    game.move(m.san);
                    const isMate = game.in_checkmate();
                    game.undo();
                    return isMate;
                });

                if (mates.length > 0) {
                    chosenMove = mates[0];
                } else if (captures.length > 0) {
                     chosenMove = captures[0];
                } else {
                     chosenMove = moves[Math.floor(Math.random() * moves.length)];
                }
            }

            if (!chosenMove) chosenMove = moves[Math.floor(Math.random() * moves.length)];

            game.move(chosenMove.san);
            drawBoard();
            addMoveToHistory(game.history({ verbose: true }).pop());
            
            if (game.in_checkmate()) {
                alert(`CHECKMATE! Nexus (${currentElo}) Wins.`);
            }
        }

        // --- 5. UI UPDATES ---
        function updateStatus() {
            const statusEl = document.getElementById('game-status');
            const indicator = document.getElementById('turn-indicator');
            
            if (game.game_over()) {
                statusEl.innerText = "GAME OVER";
                statusEl.className = "font-mono text-sm tracking-widest text-red-500 animate-pulse";
            } else {
                if (game.turn() === 'w') {
                    statusEl.innerText = "WHITE TO MOVE";
                    statusEl.className = "font-mono text-sm tracking-widest text-cyan-400";
                    indicator.className = "w-3 h-3 rounded-full bg-white shadow-[0_0_10px_white]";
                } else {
                    statusEl.innerText = `NEXUS (${currentElo}) THINKING`;
                    statusEl.className = "font-mono text-sm tracking-widest text-gray-400";
                    indicator.className = "w-3 h-3 rounded-full bg-gray-500";
                }
            }
        }

        function addMoveToHistory(move) {
            const list = document.getElementById('move-history');
            const moveNum = Math.ceil(game.history().length / 2);
            
            const div = document.createElement('div');
            div.className = "flex items-center justify-between p-2 rounded bg-white/5 border border-transparent hover:border-cyan-500/30 transition-all font-mono text-xs";
            div.innerHTML = `
                <span class="text-gray-500">${game.turn() === 'b' ? moveNum + '.' : '...'}</span>
                <span class="text-white">${move.san}</span>
                <span class="text-cyan-400 opacity-50">+0.${Math.floor(Math.random()*9)}</span>
            `;
            list.prepend(div);
        }

        function resetGame() {
            game.reset();
            selectedSquare = null;
            document.getElementById('move-history').innerHTML = '<div class="text-xs text-gray-500 font-mono mb-2">MOVE SEQUENCE</div>';
            document.getElementById('ai-feedback').innerHTML = '<p>> SYSTEM RESET.</p><p>> READY.</p>';
            drawBoard();
        }

        // --- 6. GEMINI API INTEGRATION ---
        async function analyzeWithGemini(mode) {
            const feedbackEl = document.getElementById('ai-feedback');
            
            if (!apiKey) {
                feedbackEl.innerHTML = '<p class="text-red-400">> ERROR: API KEY MISSING.</p><p class="text-gray-400">Please configure in Settings.</p>';
                return;
            }

            feedbackEl.innerHTML = '<p class="animate-pulse text-cyan-400">> ESTABLISHING UPLINK...</p>';

            const pgn = game.pgn();
            const fen = game.fen();
            const turn = game.turn() === 'w' ? 'White' : 'Black';
            const history = game.history().slice(-4).join(', ');
            
            let systemPrompt = "";
            let userPrompt = "";

            if (mode === 'strategic') {
                systemPrompt = `You are Nexus, a hyper-advanced chess AI from a cyberpunk future. Your analysis is cold, precise, and strategic.
                Current Elo context: ${currentElo}. 
                Analyze the current position briefly.
                1. Assessment (Who is winning?)
                2. Key Threat (What should I watch out for?)
                3. Best Plan (One sentence strategy).
                Keep it under 60 words. Use formatting like **bold** for emphasis.`;
                
                userPrompt = `Current FEN: ${fen}. Last moves: ${history}. It is ${turn}'s turn to move.`;
            } else if (mode === 'roast') {
                systemPrompt = `You are Nexus, a trash-talking chess AI.
                Roast the player's last move or current position. Be sarcastic, futuristic, and slightly arrogant. 
                Keep it under 40 words.`;
                userPrompt = `Current FEN: ${fen}. Last moves: ${history}. Roast the situation.`;
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userPrompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }

                const aiText = data.candidates[0].content.parts[0].text;
                
                // Parse markdown and display
                feedbackEl.innerHTML = marked.parse(aiText);
                
            } catch (error) {
                console.error(error);
                feedbackEl.innerHTML = `<p class="text-red-400">> UPLINK FAILED.</p><p class="text-xs text-gray-500">${error.message}</p>`;
            }
        }

        // --- 7. MODAL LOGIC & SETTINGS ---
        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            if (modal.classList.contains('modal-hidden')) {
                modal.classList.remove('modal-hidden');
                modal.classList.add('modal-flex');
            } else {
                modal.classList.add('modal-hidden');
                modal.classList.remove('modal-flex');
            }
        }

        function saveSettings() {
            const keyInput = document.getElementById('api-key-input').value;
            const eloInput = document.getElementById('elo-select').value;
            
            if(keyInput) {
                localStorage.setItem('nexus_api_key', keyInput);
                apiKey = keyInput;
                updateApiStatus(true);
            }
            
            localStorage.setItem('nexus_elo', eloInput);
            currentElo = eloInput;
            
            // Update UI
            document.getElementById('display-elo').innerText = currentElo;
            
            toggleSettings();
            
            const feedback = document.getElementById('ai-feedback');
            feedback.innerHTML = `<p>> SETTINGS SYNCED.</p><p>> ELO: ${currentElo}</p><p>> NEURAL LINK: ACTIVE</p>`;
        }

        // Init
        drawBoard();

    </script>
</body>
</html>




